<!DOCTYPE html>
<html lang="id">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Stok Bahan Ajar</title>
	<link rel="icon" type="image/png" href="assets/logo-UT.png">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="css/styles.css">
</head>

<body>
	<div id="navbar"></div>
	<div id="stokApp" class="container my-4">
		<h1 class="h4 text-primary mb-3">Stok Bahan Ajar</h1>

		<!-- Controls: filters + sort -->
		<div class="card mb-3 p-3">
			<div class="row g-2">
				<div class="col-md-3">
					<label class="form-label">UT - Daerah</label>
					<select class="form-select" v-model="filters.upbjj">
						<option value="">Semua Daerah</option>
						<option v-for="u in upbjjList" :key="u" :value="u">{{ u }}</option>
					</select>
				</div>

				<div class="col-md-3">
					<label class="form-label">Kategori</label>
					<select class="form-select" v-model="filters.kategori" :disabled="!filters.upbjj">
						<option value="">Semua Kategori</option>
						<option v-for="k in kategoriOptions" :key="k" :value="k">{{ k }}</option>
					</select>
				</div>

				<div class="col-md-3">
					<label class="form-label">Filter Stok (qty)</label>
					<select class="form-select" v-model="filters.stockFlag">
						<option value="">Semua</option>
						<option value="belowSafety">qty &lt; safety</option>
						<option value="zero">qty = 0</option>
					</select>
				</div>

				<div class="col-md-3">
					<label class="form-label">Sort By</label>
					<select class="form-select" v-model="sortBy">
						<option value="">Default</option>
						<option value="judul">Judul (A→Z)</option>
						<option value="qty_desc">Stok qty(terbanyak)</option>
						<option value="qty_asc">Stok qty(tersedikit)</option>
						<option value="harga_desc">Harga (tertinggi)</option>
						<option value="harga_asc">Harga (terendah)</option>
					</select>
				</div>

				<div class="col-12 text-end mt-2">
					<button class="btn btn-sm btn-secondary me-2" @click="resetFilters()">Reset Filter</button>
					<button class="btn btn-sm btn-primary" @click="openAdd()">Tambah Bahan Ajar</button>
				</div>
			</div>
		</div>

		<!-- Table -->
		<div class="card mb-4">
			<div class="card-body p-0">
				<div class="table-responsive">
					<table class="table table-hover mb-0">
						<thead class="table-light">
							<tr>
								<th class="text-center">Kode</th>
								<th class="text-center">Judul</th>
								<th class="text-center">Kategori</th>
								<th class="text-center">UT-Daerah</th>
								<th class="text-center">Lokasi Rak</th>
								<th class="text-center">Harga</th>
								<th class="text-center">Qty</th>
								<th class="text-center">Safety</th>
								<th class="text-center">Status</th>
								<th class="text-center">Catatan</th>
								<th >Aksi</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="(row, idx) in displayed" :key="row.kode">
								<td class="text-center">{{ row.kode }}</td>
								<td class="text-center">{{ row.judul }}</td>
								<td class="text-center">{{ row.kategori }}</td>
								<td class="text-center">{{ row.upbjj }}</td>
								<td class="text-center">{{ row.lokasiRak }}</td>
								<td class="text-center">Rp {{ row.harga.toLocaleString('id-ID') }}</td>
								<td class="text-center">{{ row.qty }}</td>
								<td class="text-center">{{ row.safety }}</td>
								<td class="text-center">
									<span v-if="row.qty === 0" class="text-danger fw-semibold">● Kosong</span>
									<span v-else-if="row.qty < row.safety" class="text-warning fw-semibold">●
										Menipis</span>
									<span v-else class="text-success fw-semibold">● Aman</span>
								</td>
								<td v-html="row.catatanHTML"></td>
								<td>
									<button class="btn btn-sm btn-outline-primary me-1"
										@click="openEdit(idx)">Edit</button>
								</td>
							</tr>
							<tr v-if="displayed.length === 0">
								<td colspan="10" class="text-center text-muted py-4">Tidak ada data.</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Edit/Add Modal -->
		<div class="modal" tabindex="-1" role="dialog" :class="{show: modalOpen}" style="display: block;"
			v-if="modalOpen">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">{{ editIndex === null ? 'Tambah Bahan Ajar' : 'Edit Bahan Ajar' }}</h5>
						<button type="button" class="btn-close" @click="closeModal()"></button>
					</div>
					<div class="modal-body">
						<form @submit.prevent="saveItem">
							<div class="row g-2">
								<div class="col-md-4">
									<label class="form-label required">Kode</label>
									<input class="form-control" v-model.trim="form.kode" :readonly="editIndex!==null"
										required placeholder="Misal: EKMA4116">
								</div>

								<div class="col-md-8">
									<label class="form-label required">Judul</label>
									<input class="form-control" v-model.trim="form.judul"
										placeholder="Masukkan nama bahan ajar" required>
								</div>

								<div class="col-md-4">
									<label class="form-label required">Kategori</label>
									<select class="form-select" v-model="form.kategori" required>
										<option disabled value="">Pilih kategori</option>
										<option v-for="k in kategoriList" :key="k" :value="k">{{ k }}</option>
									</select>
								</div>

								<div class="col-md-4">
									<label class="form-label required">UT-Daerah</label>
									<select class="form-select" v-model="form.upbjj" required>
										<option disabled value="">Pilih UT daerah</option>
										<option v-for="u in upbjjList" :key="u" :value="u">{{ u }}</option>
									</select>
								</div>

								<div class="col-md-4">
									<label class="form-label required">Lokasi Rak</label>
									<input class="form-control" v-model.trim="form.lokasiRak"
										placeholder="Contoh: R1-A3" required>
								</div>

								<div class="col-md-4">
									<label class="form-label required">Harga</label>
									<input type="number" class="form-control" v-model.number="form.harga"
										placeholder="Masukkan harga" min="0" required>
								</div>

								<div class="col-md-4">
									<label class="form-label required">Qty</label>
									<input type="number" class="form-control" v-model.number="form.qty"
										placeholder="Masukkan qty" min="0" required>
								</div>

								<div class="col-md-4">
									<label class="form-label required">Safety</label>
									<input type="number" class="form-control" v-model.number="form.safety"
										placeholder="Masukkan safety" min="0" required>
								</div>

								<div class="col-12">
									<label class="form-label">Catatan (HTML allowed)</label>
									<textarea class="form-control" v-model="form.catatanHTML" rows="2"
										placeholder="Masukkan catatan (Opsional)"></textarea>
								</div>
							</div>

							<div class="mt-3 text-end">
								<button type="button" class="btn btn-secondary me-2"
									@click="closeModal()">Batal</button>
								<button type="submit" class="btn btn-primary">{{ editIndex===null ? 'Tambah' : 'Simpan'
									}}</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

	</div>

	<div id="toastSuccess" class="toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-4"
		role="alert" aria-live="assertive" aria-atomic="true">
		<div class="d-flex">
			<div class="toast-body fw-semibold">
				✔ Berhasil!
			</div>
			<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
				aria-label="Close"></button>
		</div>
	</div>

	<!-- libs -->
	<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
	<!-- data -->
	<script src="js/dataBahanAjar.js"></script>
	<!-- app -->
	<script src="js/stok-app.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		function showToastSuccess(msg) {
			const toastEl = document.getElementById('toastSuccess');
			toastEl.querySelector('.toast-body').textContent = msg;
			const t = new bootstrap.Toast(toastEl, { delay: 2000 });
			t.show();
		}
	</script>


	<script>
		const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
		if (!currentUser) window.location.href = 'index.html';
		fetch('partials/navbar.html').then(r => r.text()).then(html => {
			document.getElementById('navbar').innerHTML = html;
			const el = document.getElementById('userName');
			if (el) el.textContent = currentUser.nama;
		});
		function logout() { sessionStorage.removeItem('currentUser'); window.location.href = 'index.html'; }
		window.logout = logout;
	</script>

</body>

</html>