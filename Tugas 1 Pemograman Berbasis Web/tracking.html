<!DOCTYPE html>
<html lang="id">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Tracking Pengiriman</title>
	<link rel="icon" type="image/png" href="assets/logo-UT.png">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="css/styles.css">
</head>

<body>
	<div id="navbar"></div>

	<div class="container my-4">
		<div class="card shadow-sm tracking-card">
			<div class="card-body">
				<h1 class="h4 text-primary fw-semibold border-bottom pb-2 mb-3">Tracking Pengiriman</h1>

				<form id="formTracking" class="row g-2">
					<div class="col-12 col-md-6">
						<label for="inputNomorDO" class="form-label required">Nomor Delivery Order</label>
						<input type="text" class="form-control" id="inputNomorDO" placeholder="Masukkan Nomor DO"
							required>
					</div>
					<div class="col-12 col-md-3 d-flex align-items-end">
						<button type="submit" class="btn btn-primary w-100" id="btnCari">Cari</button>
					</div>
				</form>

				<div id="alertNoDO"
					class="custom-alert d-none mt-3 p-3 rounded-3 border border-warning bg-warning-subtle text-dark">
					<div class="d-flex align-items-start">
						<div class="me-3 fs-4 text-warning">⚠️</div>
						<div>
							<h6 class="fw-semibold mb-1 text-warning">Nomor DO Tidak Ditemukan</h6>
							<p class="mb-0 small">
								Pastikan nomor yang Anda masukkan sudah benar. Periksa kembali Nomor Delivery Order dan
								coba lagi.
							</p>
						</div>
					</div>
				</div>

				<div id="hasilWrapper" class="mt-4 d-none">
					<div class="bg-primary bg-opacity-10 border-start border-4 border-primary rounded-3 p-3 mb-4">
						<div class="d-flex justify-content-between align-items-center flex-wrap">
							<div>
								<div class="text-muted small">Nomor Delivery Order</div>
								<div id="hasilNomorDO" class="fs-5 fw-bold text-primary"></div>
							</div>
							<div class="text-end mt-2 mt-md-0">
								<span class="text-muted small d-block">Status Pengiriman</span>
								<span id="hasilStatusBadge" class="badge bg-secondary fs-6 px-3 py-2"></span>
							</div>
						</div>
					</div>

					<div class="row g-4">

						<div class="col-12 col-lg-5">
							<div class="border rounded-3 p-3 h-100 bg-light">
								<h2 class="h6 text-primary fw-semibold mb-3">Informasi Penerima</h2>
								<div class="mb-2">
									<span class="text-muted small d-block">Nama Mahasiswa</span>
									<div id="hasilNama" class="fw-semibold"></div>
								</div>
								<div class="mt-3">
									<span class="text-muted small d-block mb-1">Progress Pengiriman</span>
									<div class="d-flex align-items-center gap-3">
										<div class="progress flex-grow-1" role="progressbar" aria-valuemin="0"
											aria-valuemax="100">
											<div id="hasilProgressBar" class="progress-bar bg-primary"
												style="width: 0%"></div>
										</div>
										<span id="hasilProgressText" class="fw-semibold small text-primary"></span>
									</div>
								</div>
							</div>
						</div>

						<div class="col-12 col-lg-7">
							<div class="row g-3">
								<div class="col-12">
									<div class="card border-primary">
										<div class="card-body p-3">
											<h2 class="h6 text-primary fw-semibold mb-2">Detail Pengiriman</h2>
											<table class="table table-sm mb-0">
												<tbody>
													<tr>
														<td class="text-muted small">Ekspedisi</td>
														<td id="hasilEkspedisi" class="fw-semibold text-end"></td>
													</tr>
													<tr>
														<td class="text-muted small">Tanggal Kirim</td>
														<td id="hasilTanggalKirim" class="fw-semibold text-end"></td>
													</tr>
													<tr>
														<td class="text-muted small">Jenis Paket</td>
														<td id="hasilPaket" class="fw-semibold text-end"></td>
													</tr>
													<tr>
														<td class="text-muted small">Total Pembayaran</td>
														<td id="hasilTotal" class="fw-semibold text-end"></td>
													</tr>
												</tbody>
											</table>
										</div>
									</div>
								</div>

								<div class="col-12">
									<div class="card border-primary">
										<div class="card-body p-3">
											<h2 class="h6 text-primary fw-semibold mb-2">Riwayat Perjalanan</h2>
											<ul id="hasilPerjalanan" class="list-group list-group-flush mt-2 small">
											</ul>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
			<script src="js/data.js"></script>
			<script>

				const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
				if (!currentUser) window.location.href = 'index.html';

				fetch('partials/navbar.html').then(r => r.text()).then(html => {
					document.getElementById('navbar').innerHTML = html;
					const el = document.getElementById('userName');
					if (el) el.textContent = currentUser.nama;
				});

				function hitungProgress(perjalanan = []) {
					if (!perjalanan.length) return { p: 10, lbl: 'Diproses', bar: 'bg-secondary', badge: 'bg-secondary' };
					const last = (perjalanan[perjalanan.length - 1]?.keterangan || '').toLowerCase();
					if (last.includes('selesai antar')) return { p: 100, lbl: 'Terkirim', bar: 'bg-success', badge: 'bg-success' };
					if (last.includes('proses antar')) return { p: 80, lbl: 'Sedang Diantar', bar: 'bg-primary', badge: 'bg-primary' };
					if (last.includes('tiba di hub')) return { p: 60, lbl: 'Di Hub', bar: 'bg-info', badge: 'bg-warning' };
					if (last.includes('penerimaan di loket')) return { p: 30, lbl: 'Diterima di Loket', bar: 'bg-secondary', badge: 'bg-secondary' };
					return { p: 40, lbl: 'Dalam Perjalanan', bar: 'bg-info', badge: 'bg-warning' };
				}

				function renderHasil(noDO, d) {
					document.getElementById('hasilWrapper').classList.remove('d-none');
					document.getElementById('alertNoDO').classList.add('d-none');

					document.getElementById('hasilNomorDO').textContent = noDO;
					document.getElementById('hasilNama').textContent = d.nama || '-';

					const prog = hitungProgress(d.perjalanan);
					const status = document.getElementById('hasilStatusBadge');
					status.className = `badge ${prog.badge}`;
					status.textContent = d.status || prog.lbl;

					const bar = document.getElementById('hasilProgressBar');
					bar.className = `progress-bar ${prog.bar}`;
					bar.style.width = prog.p + '%';
					document.getElementById('hasilProgressText').textContent = prog.p + '%';

					document.getElementById('hasilEkspedisi').textContent = d.ekspedisi || '-';
					document.getElementById('hasilTanggalKirim').textContent = d.tanggalKirim || '-';
					document.getElementById('hasilPaket').textContent = d.paket || '-';
					document.getElementById('hasilTotal').textContent = d.total || '-';

					const ul = document.getElementById('hasilPerjalanan');
					ul.innerHTML = '';
					(d.perjalanan || []).forEach(i => {
						const li = document.createElement('li');
						li.className = 'list-group-item';
						li.innerHTML = `<div class="small text-muted">${i.waktu || '-'}</div><div>${i.keterangan || '-'}</div>`;
						ul.appendChild(li);
					});
				}

				function renderNotFound() {
					document.getElementById('hasilWrapper').classList.add('d-none');
					document.getElementById('alertNoDO').classList.remove('d-none');
				}

				document.getElementById('formTracking').addEventListener('submit', e => {
					e.preventDefault();
					const no = document.getElementById('inputNomorDO').value.trim();
					if (!no) return renderNotFound();
					const data = dataTracking?.[no];
					data ? renderHasil(no, data) : renderNotFound();
				});

				function logout() { sessionStorage.removeItem('currentUser'); window.location.href = 'index.html'; }
				window.logout = logout;
			</script>
</body>

</html>