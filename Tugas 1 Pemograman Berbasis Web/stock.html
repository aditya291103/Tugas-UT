<!DOCTYPE html>
<html lang="id">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Stok Bahan Ajar</title>
	<link rel="icon" type="image/png" href="assets/logo-UT.png">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="css/styles.css">
</head>

<body>
	<div id="navbar"></div>
	<div class="container my-4">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<h1 class="h4 text-primary fw-semibold m-0">Stok Bahan Ajar</h1>
		</div>
		<div class="card mb-4">
			<div class="card-body">
				<div class="table-responsive">
					<table class="table table-hover align-middle small text-center">
						<thead class="table-primary text-dark">
							<tr>
								<th scope="col">Kode Lokasi</th>
								<th scope="col">Kode Barang</th>
								<th scope="col">Nama Barang</th>
								<th scope="col">Jenis</th>
								<th scope="col">Edisi</th>
								<th scope="col" class="text-end">Stok</th>
								<th scope="col">Cover</th>
							</tr>
						</thead>
						<tbody id="tbodyStok"></tbody>
					</table>
				</div>
			</div>
		</div>
		<div class="card">
			<div class="card-body">
				<h2 class="h6 text-primary fw-semibold mb-3 border-bottom pb-2">Tambah Stok Baru</h2>
				<form id="formTambah" class="row g-3">
					<div class="col-12 col-md-3">
						<label class="form-label required" for="inLokasi">Kode Lokasi</label>
						<input id="inLokasi" class="form-control" placeholder="Masukkan Kode Lokasi" required>
					</div>
					<div class="col-12 col-md-3">
						<label class="form-label required" for="inKode">Kode Barang</label>
						<input id="inKode" class="form-control" placeholder="Masukkan Kode Barang" required>
					</div>
					<div class="col-12 col-md-6">
						<label class="form-label required" for="inNama">Nama Barang</label>
						<input id="inNama" class="form-control" placeholder="Masukkan Nama Barang" required>
					</div>
					<div class="col-12 col-md-3">
						<label class="form-label required" for="inJenis">Jenis</label>
						<select id="inJenis" class="form-select" required>
							<option value="" selected disabled>Pilih jenis</option>
							<option value="BMP">BMP</option>
							<option value="Non-BMP">Non-BMP</option>
						</select>
					</div>
					<div class="col-6 col-md-2">
						<label class="form-label required" for="inEdisi">Edisi</label>
						<input id="inEdisi" type="number" min="1" class="form-control" placeholder="Masukkan Edisi"
							required>
					</div>
					<div class="col-6 col-md-2">
						<label class="form-label required" for="inStok">Stok</label>
						<input id="inStok" type="number" min="0" class="form-control" placeholder="Masukkan Stok"
							required>
					</div>
					<div class="col-12 col-md-5">
						<label class="form-label" for="inCover">Cover</label>
						<input id="inCover" type="file" accept="image/*" class="form-control">
					</div>
					<div class="col-12 text-end mt-3">
						<button type="submit" class="btn btn-primary px-4 fw-semibold">Tambah Stok</button>
					</div>
			</div>
			</form>
		</div>
	</div>

	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="js/data.js"></script>
	<script>
		const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
		if (!currentUser) window.location.href = 'index.html';
		fetch('partials/navbar.html').then(r => r.text()).then(html => {
			document.getElementById('navbar').innerHTML = html;
			const el = document.getElementById('userName');
			if (el) el.textContent = currentUser.nama;
		});
		function logout() { sessionStorage.removeItem('currentUser'); window.location.href = 'index.html'; }
		window.logout = logout;
		function buatBaris(x) {
			const tr = document.createElement('tr');
			tr.innerHTML = `
				<td>${x.kodeLokasi || '-'}</td>
				<td>${x.kodeBarang || '-'}</td>
				<td>${x.namaBarang || '-'}</td>
				<td>${x.jenisBarang || '-'}</td>
				<td>${x.edisi ?? '-'}</td>
				<td class="fw-semibold text-end text-primary">${x.stok ?? '-'}</td>
				<td>${x.cover ? `<img src="${x.cover}" alt="cover" class="cover-44 rounded clickable-cover" 
                 data-bs-toggle="modal" data-bs-target="#previewModal" data-cover="${x.cover}">` : '-'}</td>
			`;
			return tr;
		}
		function renderTabel() {
			const tbody = document.getElementById('tbodyStok');
			tbody.innerHTML = '';
			(dataBahanAjar || []).forEach(x => tbody.appendChild(buatBaris(x)));
		}
		renderTabel();
		document.getElementById('formTambah').addEventListener('submit', e => {
			e.preventDefault();
			const file = inCover.files[0]; // ambil file gambar (jika ada)
			const reader = new FileReader();

			reader.onload = function () {
				const item = {
					kodeLokasi: inLokasi.value.trim(),
					kodeBarang: inKode.value.trim(),
					namaBarang: inNama.value.trim(),
					jenisBarang: inJenis.value,
					edisi: Number(inEdisi.value),
					stok: Number(inStok.value),
					cover: file ? reader.result : '' // hasil base64 dari FileReader
				};
				if (!item.kodeLokasi || !item.kodeBarang || !item.namaBarang || !item.jenisBarang) return;
				if (isNaN(item.edisi) || isNaN(item.stok)) return;

				dataBahanAjar.push(item);
				document.getElementById('tbodyStok').appendChild(buatBaris(item));
				e.target.reset();
				inJenis.value = '';

			};

			if (file) {
				reader.readAsDataURL(file); // baca file gambar jadi data URL
			} else {
				reader.onload(); // kalau tidak ada file, lanjutkan tetap
			}

		});
		document.addEventListener('click', function (e) {
			if (e.target.classList.contains('clickable-cover')) {
				const imgSrc = e.target.getAttribute('data-cover');
				document.getElementById('previewImage').src = imgSrc;
			}
		});
	</script>
	<!-- Modal Preview Gambar -->
	<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content border-0 shadow">
				<div class="modal-header border-0">
					<h5 class="modal-title" id="previewModalLabel">Preview Cover</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
				</div>
				<div class="modal-body text-center">
					<img id="previewImage" src="" alt="Preview" class="img-fluid rounded shadow-sm">
				</div>
			</div>
		</div>
	</div>
</body>

</html>